{% extends 'frontend/base.html' %}

{% block title %}{{ resource.name }} - Computational Resource - OpenModelsHub{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="mb-2">
            <i class="bi bi-servers"></i> {{ resource.name }}
            <span class="badge {% if resource.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                {% if resource.is_active %}Active{% else %}Inactive{% endif %}
            </span>
            <span class="badge
                {% if resource.resource_type == 'cloud' %}bg-primary
                {% elif resource.resource_type == 'local' %}bg-success
                {% else %}bg-info{% endif %}">
                {{ resource.get_resource_type_display }}
            </span>
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'frontend:home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'frontend:resources_dashboard' %}">Resources</a></li>
                <li class="breadcrumb-item active">{{ resource.name|truncatechars:30 }}</li>
            </ol>
        </nav>
    </div>
    <div class="text-end">
        <a href="{% url 'admin:resources_computationalresource_change' resource.id %}" class="btn btn-outline-warning">
            <i class="bi bi-pencil"></i> Edit
        </a>
    </div>
</div>

<!-- Resource Overview -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Resource Specifications</h5>
            </div>
            <div class="card-body">
                {% if resource.description %}
                    <p class="card-text">{{ resource.description }}</p>
                {% endif %}

                <div class="row">
                    <div class="col-md-6">
                        <div class="metadata-section">
                            <h6><i class="bi bi-geo-alt"></i> Location & Infrastructure</h6>
                            <div class="mb-2">
                                <strong>Location:</strong><br>
                                {{ resource.location }}
                            </div>
                            <div class="mb-2">
                                <strong>Resource Type:</strong><br>
                                <span class="badge
                                    {% if resource.resource_type == 'cloud' %}bg-primary
                                    {% elif resource.resource_type == 'local' %}bg-success
                                    {% else %}bg-info{% endif %}">
                                    {{ resource.get_resource_type_display }}
                                </span>
                            </div>
                            {% if resource.provider %}
                                <div class="mb-2">
                                    <strong>Provider:</strong><br>
                                    {{ resource.provider }}
                                </div>
                            {% endif %}
                            {% if resource.instance_type %}
                                <div class="mb-2">
                                    <strong>Instance Type:</strong><br>
                                    <code>{{ resource.instance_type }}</code>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metadata-section">
                            <h6><i class="bi bi-cpu"></i> Hardware Specifications</h6>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="border rounded p-3 mb-2">
                                        <div class="fs-3 fw-bold text-primary">{{ resource.cpu_cores|default:"N/A" }}</div>
                                        <div class="text-muted small">CPU Cores</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded p-3 mb-2">
                                        <div class="fs-3 fw-bold text-success">{{ resource.memory_gb|default:"N/A" }}</div>
                                        <div class="text-muted small">RAM (GB)</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="border rounded p-3 mb-2">
                                        <div class="fs-3 fw-bold text-warning">{{ resource.gpu_count|default:"0" }}</div>
                                        <div class="text-muted small">GPU Count</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded p-3">
                                        <div class="fs-3 fw-bold text-info">{{ resource.storage_gb|default:"N/A" }}</div>
                                        <div class="text-muted small">Storage (GB)</div>
                                    </div>
                                </div>
                            </div>
                            {% if resource.gpu_model %}
                                <div class="mt-3">
                                    <strong>GPU Model:</strong><br>
                                    <span class="badge bg-warning">{{ resource.gpu_model }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Sustainability Information -->
                <div class="metadata-section">
                    <h6><i class="bi bi-leaf"></i> Sustainability & Energy</h6>
                    <div class="row">
                        <div class="col-md-6">
                            {% if resource.energy_source %}
                                <div class="mb-2">
                                    <strong>Energy Source:</strong><br>
                                    <span class="badge {% if resource.energy_source == 'renewable' %}bg-success{% else %}bg-warning{% endif %}">
                                        <i class="bi bi-lightning"></i> {{ resource.get_energy_source_display }}
                                    </span>
                                </div>
                            {% endif %}
                            {% if resource.carbon_intensity_kg_co2_kwh %}
                                <div class="mb-2">
                                    <strong>Carbon Intensity:</strong><br>
                                    {{ resource.carbon_intensity_kg_co2_kwh }} kg CO₂/kWh
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if resource.cost_per_hour %}
                                <div class="mb-2">
                                    <strong>Cost per Hour:</strong><br>
                                    <span class="fw-bold">${{ resource.cost_per_hour }}</span>
                                </div>
                            {% endif %}
                            {% if resource.power_consumption_watts %}
                                <div class="mb-2">
                                    <strong>Power Consumption:</strong><br>
                                    {{ resource.power_consumption_watts }} watts
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Utilization Statistics -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Utilization Statistics</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Total Utilizations</span>
                        <span class="fw-bold">{{ total_utilizations }}</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Avg CPU Usage</span>
                        <span class="fw-bold">{{ avg_cpu }}%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar" style="width: {{ avg_cpu }}%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Avg Memory Usage</span>
                        <span class="fw-bold">{{ avg_memory }}%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: {{ avg_memory }}%"></div>
                    </div>
                </div>
                {% if resource.gpu_count > 0 %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Avg GPU Usage</span>
                            <span class="fw-bold">{{ avg_gpu }}%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-warning" style="width: {{ avg_gpu }}%"></div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Environmental Impact Summary -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-globe2"></i> Environmental Impact</h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div class="fs-4 fw-bold text-danger">{{ total_carbon }} kg</div>
                    <div class="text-muted small">Total CO₂ Emissions</div>
                </div>
                <div class="text-center mb-3">
                    <div class="fs-4 fw-bold text-warning">{{ total_energy }} kWh</div>
                    <div class="text-muted small">Total Energy Consumed</div>
                </div>
                {% if total_energy > 0 %}
                    <div class="text-center">
                        <div class="fs-6 fw-bold text-info">{{ total_carbon|floatformat:4 }} kg/kWh</div>
                        <div class="text-muted small">Carbon Efficiency</div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Cost Summary -->
        {% if total_cost > 0 %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-currency-dollar"></i> Cost Summary</h6>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div class="fs-4 fw-bold text-success">${{ total_cost }}</div>
                        <div class="text-muted small">Total Cost</div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Resource Status -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Status</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Created:</strong><br>
                    <small class="text-muted">{{ resource.created_at|date:"M d, Y" }} ({{ resource.created_at|timesince }} ago)</small>
                </div>
                <div class="mb-2">
                    <strong>Last Updated:</strong><br>
                    <small class="text-muted">{{ resource.updated_at|date:"M d, Y" }}</small>
                </div>
                {% if resource.last_maintenance %}
                    <div>
                        <strong>Last Maintenance:</strong><br>
                        <small class="text-muted">{{ resource.last_maintenance|date:"M d, Y" }}</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Utilizations -->
{% if utilizations %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-activity"></i> Recent Utilizations
                        <span class="badge bg-secondary">{{ total_utilizations }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Model/Experiment</th>
                                    <th>CPU %</th>
                                    <th>Memory %</th>
                                    <th>GPU %</th>
                                    <th>Duration</th>
                                    <th>CO₂ Impact</th>
                                    <th>Started</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for util in utilizations %}
                                    <tr>
                                        <td>
                                            {% if util.model %}
                                                <a href="{% url 'frontend:model_detail' util.model.id %}" class="text-decoration-none">
                                                    <i class="bi bi-cpu"></i> {{ util.model.name|truncatechars:25 }}
                                                </a>
                                            {% elif util.experiment %}
                                                <a href="{% url 'frontend:experiment_detail' util.experiment.id %}" class="text-decoration-none">
                                                    <i class="bi bi-graph-up"></i> {{ util.experiment.name|truncatechars:25 }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 4px;">
                                                <div class="progress-bar" style="width: {{ util.cpu_utilization_percent }}%"></div>
                                            </div>
                                            {{ util.cpu_utilization_percent }}%
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 4px;">
                                                <div class="progress-bar bg-success" style="width: {{ util.memory_utilization_percent }}%"></div>
                                            </div>
                                            {{ util.memory_utilization_percent }}%
                                        </td>
                                        <td>
                                            {% if util.gpu_utilization_percent %}
                                                <div class="progress" style="height: 4px;">
                                                    <div class="progress-bar bg-warning" style="width: {{ util.gpu_utilization_percent }}%"></div>
                                                </div>
                                                {{ util.gpu_utilization_percent }}%
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if util.duration_seconds %}
                                                {% if util.duration_seconds < 3600 %}
                                                    {{ util.duration_seconds|floatformat:"0" }}s
                                                {% else %}
                                                    {% widthratio util.duration_seconds 3600 1 %}h
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if util.environmental_impact %}
                                                <span class="fw-bold {% if util.environmental_impact.carbon_footprint_kg >= 5 %}text-danger{% elif util.environmental_impact.carbon_footprint_kg >= 1 %}text-warning{% else %}text-success{% endif %}">
                                                    {{ util.environmental_impact.carbon_footprint_kg }} kg
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ util.start_time|timesince }} ago</small>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- Environmental Impact History -->
{% if environmental_impacts %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-globe2"></i> Environmental Impact History</h5>
                </div>
                <div class="card-body">
                    {% for impact in environmental_impacts %}
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                            <div>
                                <h6 class="mb-1">
                                    {% if impact.resource_utilization.model %}
                                        <i class="bi bi-cpu"></i>
                                        <a href="{% url 'frontend:model_detail' impact.resource_utilization.model.id %}" class="text-decoration-none">
                                            {{ impact.resource_utilization.model.name }}
                                        </a>
                                    {% elif impact.resource_utilization.experiment %}
                                        <i class="bi bi-graph-up"></i>
                                        <a href="{% url 'frontend:experiment_detail' impact.resource_utilization.experiment.id %}" class="text-decoration-none">
                                            {{ impact.resource_utilization.experiment.name }}
                                        </a>
                                    {% else %}
                                        <i class="bi bi-activity"></i> Resource Utilization
                                    {% endif %}
                                </h6>
                                <small class="text-muted">{{ impact.created_at|timesince }} ago</small>
                            </div>
                            <div class="text-end">
                                <div class="fs-6 fw-bold {% if impact.carbon_footprint_kg >= 5 %}text-danger{% elif impact.carbon_footprint_kg >= 1 %}text-warning{% else %}text-success{% endif %}">
                                    {{ impact.carbon_footprint_kg }} kg CO₂
                                </div>
                                <div class="fs-7 text-warning">{{ impact.energy_consumption_kwh }} kWh</div>
                                {% if impact.carbon_intensity_kg_co2_kwh %}
                                    <small class="text-muted">{{ impact.carbon_intensity_kg_co2_kwh|floatformat:4 }} kg/kWh</small>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- Cost History -->
{% if costs %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Cost History</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Compute Cost</th>
                                    <th>Storage Cost</th>
                                    <th>Network Cost</th>
                                    <th>Total Cost</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cost in costs %}
                                    <tr>
                                        <td>{{ cost.billing_period }}</td>
                                        <td>${{ cost.compute_cost|default:"0.00" }}</td>
                                        <td>${{ cost.storage_cost|default:"0.00" }}</td>
                                        <td>${{ cost.network_cost|default:"0.00" }}</td>
                                        <td><strong>${{ cost.total_cost }}</strong></td>
                                        <td><small class="text-muted">{{ cost.created_at|date:"M d, Y" }}</small></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- Actions -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="{% url 'frontend:resources_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Resources
                </a>
            </div>
            <div>
                <a href="{% url 'admin:resources_computationalresource_change' resource.id %}" class="btn btn-outline-warning">
                    <i class="bi bi-pencil"></i> Edit Resource
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}